<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSIDMail - Inbox</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:#f3f4f6;
}

.wrapper{
  max-width:900px;
  margin:auto;
  padding:20px;
}

.card{
  background:#fff;
  padding:25px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 5px 20px rgba(0,0,0,0.08);
}

.mail{
  border-bottom:1px solid #eee;
  padding:18px 0;
}

.mail:last-child{
  border-bottom:none;
}

.subject{
  font-weight:600;
  font-size:16px;
  margin-bottom:6px;
}

.meta{
  font-size:12px;
  color:#666;
}

.mail-body{
  margin-top:12px;
  font-size:14px;
  line-height:1.6;
  white-space:pre-wrap;
}

.otp-box{
  background:#fff3cd;
  border:1px solid #ffeeba;
  padding:10px;
  border-radius:6px;
  margin:10px 0;
  font-weight:bold;
  color:#856404;
}

.link-buttons{
  margin-top:10px;
}

.btn-link{
  display:inline-block;
  padding:8px 14px;
  background:#6366f1;
  color:white;
  border-radius:6px;
  text-decoration:none;
  font-size:13px;
  margin:5px 5px 0 0;
}

.btn-link:hover{
  background:#4f46e5;
}

.empty{
  text-align:center;
  color:#888;
  padding:30px 0;
}
</style>
</head>
<body>

<div class="wrapper">

<div class="card">
  <h2>üì• Inbox</h2>
  <div id="inboxContent">Loading...</div>
</div>

</div>

<script>

const workerURL = "https://email-handler.saisoku-id2020.workers.dev/inbox?email=";
const email = localStorage.getItem("tempEmail");

if(!email){
  document.getElementById("inboxContent").innerHTML = "No email selected.";
}else{
  loadInbox();
}

async function loadInbox(){

  const inbox = document.getElementById("inboxContent");

  try{

    const res = await fetch(workerURL + email + "&t=" + Date.now());
    const data = await res.json();

    if(!data.length){
      inbox.innerHTML = `<div class="empty">No emails yet...</div>`;
      return;
    }

    let html = "";

    data.reverse().forEach(mail=>{

      let content = mail.content || "";

      /* CLEAN QUOTED PRINTABLE */
      content = content
        .replace(/=3D/g,"=")
        .replace(/=C2=A0/g," ")
        .replace(/=\r?\n/g,"")
        .replace(/MIME-Version:.*/g,"")
        .replace(/Content-Type:.*/g,"")
        .replace(/Content-Transfer-Encoding:.*/g,"");

      /* AUTO DETECT OTP */
      let otpMatch = content.match(/\b\d{4,8}\b/);
      let otpBox = "";
      if(otpMatch){
        otpBox = `<div class="otp-box">üîê OTP Code: ${otpMatch[0]}</div>`;
      }

      /* EXTRACT LINKS */
      let linkButtons = "";
      const links = content.match(/https?:\/\/[^\s)]+/g);
      if(links){
        const uniqueLinks = [...new Set(links)];
        uniqueLinks.slice(0,3).forEach(link=>{
          linkButtons += `<a href="${link}" target="_blank" class="btn-link">Open Link</a>`;
        });
      }

      html += `
      <div class="mail">
        <div class="subject">${mail.subject || "(No Subject)"}</div>
        <div class="meta">${mail.from || ""}</div>
        <div class="meta">${mail.date || ""}</div>

        ${otpBox}

        <div class="mail-body">${content}</div>

        <div class="link-buttons">${linkButtons}</div>
      </div>
      `;
    });

    inbox.innerHTML = html;

  }catch(e){
    inbox.innerHTML = "Failed to load inbox.";
  }
}

</script>

</body>
</html>
