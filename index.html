<script>

const workerURL = "/inbox?email=";
let refreshInterval = 30;
let secondsLeft = refreshInterval;
let timer;
let loading = false;

/* CREATE */
function createEmail(){
  const user = document.getElementById("username").value.trim();
  if(!user){ alert("Enter username first"); return; }

  const email = user + "@ssidmail.my.id";
  document.getElementById("email").innerText = email;
  localStorage.setItem("tempEmail", email);
  loadInbox(true);
}

/* COPY */
function copyEmail(){
  const email = document.getElementById("email").innerText;
  navigator.clipboard.writeText(email);
  alert("Copied!");
}

/* MANUAL REFRESH */
function manualRefresh(){
  secondsLeft = refreshInterval;
  loadInbox(true);
}

/* LOAD INBOX */
async function loadInbox(resetTimer=false){

  if(loading) return; // prevent double load
  loading = true;

  const email = localStorage.getItem("tempEmail");
  if(!email){
    loading = false;
    return;
  }

  const inbox = document.getElementById("inboxContent");
  inbox.innerHTML = "Loading...";

  try{

    const res = await fetch(workerURL + email + "&t=" + Date.now(), {
      cache: "no-store"
    });

    const text = await res.text();

    let data;
    try {
      data = JSON.parse(text);
    } catch {
      inbox.innerHTML = "Worker not returning JSON.";
      loading = false;
      return;
    }

    if(!Array.isArray(data) || data.length === 0){
      inbox.innerHTML = "No emails yet...";
      loading = false;
      return;
    }

    let html = "";

    data.reverse().forEach((mail,index)=>{

      let content = mail.content || "";

      content = content
        .replace(/=3D/g,"=")
        .replace(/=C2=A0/g," ")
        .replace(/=\r?\n/g,"")
        .replace(/MIME-Version:.*/g,"")
        .replace(/Content-Type:.*/g,"");

      let otp = content.match(/\b\d{4,8}\b/);
      let otpBox = otp ? `<div class="otp">üîê OTP: ${otp[0]}</div>` : "";

      let links = content.match(/https?:\/\/[^\s)]+/g);
      let linkButtons = "";
      if(links){
        [...new Set(links)].slice(0,3).forEach(link=>{
          linkButtons += `<a href="${link}" target="_blank" class="btn-link">Open Link</a>`;
        });
      }

      html += `
        <div class="mail" id="mail-${index}">
          <div class="mail-header" onclick="toggleMail(${index})">
            <div class="subject">${mail.subject || "(No Subject)"}</div>
            <div class="meta">${mail.from || ""}</div>
            <div class="meta">${mail.date || ""}</div>
          </div>

          <div class="mail-body">
            ${otpBox}
            <div class="mail-content">${content}</div>
            ${linkButtons}
          </div>
        </div>
      `;
    });

    inbox.innerHTML = html;

    if(resetTimer){
      secondsLeft = refreshInterval;
    }

  } catch(e){
    inbox.innerHTML = "Failed to load inbox.";
  }

  loading = false;
}

/* EXPAND */
function toggleMail(index){
  const mail = document.getElementById("mail-"+index);
  if(mail){
    mail.classList.toggle("open");
  }
}

/* RESET VIEW */
function collapseAll(){
  document.querySelectorAll(".mail").forEach(mail=>{
    mail.classList.remove("open");
  });
}

/* AUTO REFRESH */
function startTimer(){
  clearInterval(timer);

  timer = setInterval(()=>{

    const email = localStorage.getItem("tempEmail");
    if(!email) return;

    document.getElementById("countdown").innerText =
      "Auto refresh in " + secondsLeft + "s";

    secondsLeft--;

    if(secondsLeft <= 0){
      loadInbox(true);
      secondsLeft = refreshInterval;
    }

  },1000);
}

/* RESTORE */
const saved = localStorage.getItem("tempEmail");
if(saved){
  document.getElementById("email").innerText = saved;
  document.getElementById("username").value = saved.split("@")[0];
  loadInbox();
}

startTimer();

</script>
