<script>

const workerURL = "https://email-handler.saisoku-id2020.workers.dev/inbox?email=";
let autoReload = true;
let countdown = 15;
let interval;

// =============================
// CREATE EMAIL
// =============================
function createEmail(){
  const user = document.getElementById("username").value.trim();
  if(!user){ showToast("Enter username first"); return; }

  const email = user + "@ssidmail.my.id";
  document.getElementById("email").innerText = email;
  localStorage.setItem("tempEmail", email);

  loadInbox();
}

// =============================
// COPY
// =============================
function copyEmail(){
  const email = document.getElementById("email").innerText;
  if(email==="Not generated") return;

  navigator.clipboard.writeText(email);
  showToast("Copied ✔");
}

// =============================
// LOAD INBOX
// =============================
async function loadInbox(){

  const email = localStorage.getItem("tempEmail");
  if(!email){
    showToast("Create email first");
    return;
  }

  const inbox = document.getElementById("inboxContent");
  inbox.innerHTML = "Loading...";

  try {

    const response = await fetch(
      workerURL + email + "&t=" + Date.now(),
      { cache: "no-store" }
    );

    const text = await response.text();

    // Try parse JSON
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      throw new Error("Worker not returning JSON");
    }

    if(!Array.isArray(data) || data.length === 0){
      inbox.innerHTML = "No emails yet...";
      return;
    }

    let html = "";

    data.reverse().forEach(mail=>{
      html += `
      <div class="mail">
        <strong>${mail.subject || "(No Subject)"}</strong>
        <div class="meta">${mail.from || "Unknown"}</div>
        <div class="meta">${mail.date || ""}</div>
        <hr>
        <pre>${mail.content || ""}</pre>
      </div>
      `;
    });

    inbox.innerHTML = html;

  } catch(error){
    inbox.innerHTML = "⚠ Failed to load inbox.<br>Check Worker JSON mode.";
    console.error(error);
  }
}

// =============================
// AUTO RELOAD WITH COUNTDOWN
// =============================
function startAutoReload(){
  const counter = document.getElementById("timer");
  interval = setInterval(()=>{
    if(!autoReload) return;

    countdown--;
    counter.innerText = countdown;

    if(countdown <= 0){
      countdown = 15;
      loadInbox();
    }

  },1000);
}

function toggleAutoReload(){
  autoReload = !autoReload;
  document.getElementById("autoBtn").innerText =
    autoReload ? "⏸ Auto Reload ON" : "▶ Auto Reload OFF";
}

// =============================
// THEME
// =============================
function toggleMode(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",
    document.body.classList.contains("dark")?"dark":"light");
}

// =============================
// TOAST
// =============================
function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}

// =============================
// RESTORE
// =============================
const saved=localStorage.getItem("tempEmail");
if(saved){
  document.getElementById("email").innerText=saved;
  document.getElementById("username").value=saved.split("@")[0];
  loadInbox();
}

if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
}

// start timer
startAutoReload();

</script>
